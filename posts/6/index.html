
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Bowen's Blog</title>
  <meta name="author" content="Bowen Ma">

  
  <meta name="description" content="找不到共享文件是我们在native build的时候经常遇到的问题，有一种情况是操作系统上确实没有该共享文件，还有一种是含有该共享文件的目录没有被加入到library 查询的路径中。 假设现在我们需要把 /opt/lib/lib.test.so 加入到library path中. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://iambowen.github.com/posts/6/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Bowen's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40335675-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Bowen's Blog</a></h1>
  
    <h2>Respect My Authorita.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="iambowen.m@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="iambowen.github.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/linux/2013/11/18/change-system-library-path">Change System Library Path</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-11-18T00:00:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/linux/2013/11/18/change-system-library-path#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/linux/2013/11/18/change-system-library-path">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>找不到共享文件是我们在native build的时候经常遇到的问题，有一种情况是操作系统上确实没有该共享文件，还有一种是含有该共享文件的目录没有被加入到library 查询的路径中。</p>

<p>假设现在我们需要把 <code>/opt/lib/lib.test.so</code> 加入到library path中.
在不想影响到系统配置的情况下，我们可以修改环境变量:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/opt/lib:<span class="nv">$LD_LIBRARY_PATH</span>
</span></code></pre></td></tr></table></div></figure>


<p>easy right?
如果你确信你是想一劳永逸的把<code>/opt/lib/</code>加入到library path中，那么可以直接修改ldconfig的配置:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>sudo ldconfig <span class="p">|</span> grep opt
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>目前尚未出现<code>/opt/</code>。
怎么办呢？直接去修改<code>/etc/ld.so.conf.d/</code> 下的配置文件。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>ls -al /etc/ld.so.conf.d/
</span><span class='line'>total 16
</span><span class='line'>drwxr-xr-x.  <span class="m">2</span> root root <span class="m">4096</span> Mar  <span class="m">9</span>  <span class="m">2013</span> .
</span><span class='line'>drwxr-xr-x. <span class="m">65</span> root root <span class="m">4096</span> Nov <span class="m">18</span> 10:04 ..
</span><span class='line'>-r--r--r--.  <span class="m">1</span> root root  <span class="m">324</span> Feb <span class="m">22</span>  <span class="m">2013</span> kernel-2.6.32-358.el6.x86_64.conf
</span><span class='line'>-rw-r--r--.  <span class="m">1</span> root root   <span class="m">17</span> Dec  <span class="m">7</span>  <span class="m">2012</span> mysql-x86_64.conf
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>less /etc/ld.so.conf.d/mysql-x86_64.conf
</span><span class='line'>/usr/lib64/mysql
</span></code></pre></td></tr></table></div></figure>


<p>看上去规则很简单，第一步为app添加配置文件，第二步在文件中写入library的路径。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo <span class="nb">echo</span> “/opt/lib” &gt; /etc/ld.so.conf.d/opt.conf
</span></code></pre></td></tr></table></div></figure>


<p>make it happen</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ld.so.conf.d<span class="o">]</span><span class="nv">$ </span>sudo ldconfig
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ld.so.conf.d<span class="o">]</span><span class="nv">$ </span>ldconfig -v <span class="p">|</span> grep opt
</span><span class='line'>/opt/lib:
</span><span class='line'>ldconfig: File /opt/lib/lib.test.so is empty, not checked.    <span class="c">#测试文件</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, are you happy now?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/osx/2013/11/06/automately-install-dmg-package-under-osx">Automately Install Dmg Package Under OSX</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-11-06T00:00:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/osx/2013/11/06/automately-install-dmg-package-under-osx#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/osx/2013/11/06/automately-install-dmg-package-under-osx">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The common way install a new app in osx is like:</p>

<ol>
<li>Install from AppStore;</li>
<li>Download *.dmg file and open it then click install script;</li>
</ol>


<p>For the App that can only be installed from *.dmg file, there&rsquo;s a better way to automate the install process.
The second way includes following steps:</p>

<ol>
<li>Download the package-*.dmg file;</li>
<li>Mount *.dmg file to file system- e.g /Volumes/app_name</li>
<li>Install app with the installer or *.pkg file</li>
</ol>


<p>Given we want to install <a href="www.vagrantup.com">vagrant</a>:
For the  first step, say <code>curl -O download_link</code> for people don&rsquo;t have tools like <code>wget</code>. If you have <code>wget</code>, say installed through brew <code>brew install wget</code>, you can just use <code>wget</code>.</p>

<p>For the second step, we can use <code>hdiutil</code> command to mount the dmg file to <code>/Volumes</code>.</p>

<p>For the last step, the <code>installer</code> in osx perfectly solve the issue. Command like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo installer -store -pkg /Volumes/Vagrant/Vagrant.pkg -target /
</span></code></pre></td></tr></table></div></figure>


<p>And it would use the administrator previlidge to install the package.</p>

<p>For the whole install process, the only thing you need to do is type in the password. And <a href="https://raw.github.com/iambowen/vagrant_wrapper/master/install.sh">this</a> is an example for fulfilling the automation. Surely it can be improved more genericly, for I only use this for vagrant session.^_^</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/linux/2013/11/04/record-and-play-back-terminal-session">Record and Play Back Terminal Session</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-11-04T00:00:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/linux/2013/11/04/record-and-play-back-terminal-session#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/linux/2013/11/04/record-and-play-back-terminal-session">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Nowadays, lots of people would use video to record a tutorial for demonstrating. It&rsquo;s cool for vividly showing everything to people. The only issue is that file size of video is relatively large. From this point of view, the old way of recording actions from console might be a better idea.</p>

<p><code>script</code> and <code>scriptreplay</code> are console recording/playing tools. <code>script</code> would record time and actions of current session in two different files. And <code>scriptreplay</code> would play those actions again in the console。 It&rsquo;s quite easy to use these tools, just like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@bogon shell<span class="o">]</span><span class="nv">$ </span>script -t 2&gt;timing.log -a output.session
</span><span class='line'>Script started, file is output.session
</span><span class='line'><span class="o">[</span>vagrant@bogon shell<span class="o">]</span><span class="nv">$ </span>ls -al .
</span><span class='line'>total 24
</span><span class='line'>drwxrwxr-x <span class="m">2</span> vagrant vagrant <span class="m">4096</span> Nov  <span class="m">5</span> 09:37 .
</span><span class='line'>drwx------ <span class="m">4</span> vagrant vagrant <span class="m">4096</span> Nov  <span class="m">4</span> 12:15 ..
</span><span class='line'>-rw-rw-r-- <span class="m">1</span> vagrant vagrant <span class="m">4400</span> Nov  <span class="m">5</span> 09:42 output.session
</span><span class='line'>-rw-rw-r-- <span class="m">1</span> vagrant vagrant   <span class="m">55</span> Nov  <span class="m">4</span> 12:16 test.txt
</span><span class='line'>-rw-rw-r-- <span class="m">1</span> vagrant vagrant  <span class="m">111</span> Nov  <span class="m">5</span> 16:21 timing.log
</span><span class='line'><span class="o">[</span>vagrant@bogon shell<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> /tmp/
</span><span class='line'><span class="o">[</span>vagrant@bogon tmp<span class="o">]</span><span class="nv">$ </span>ls
</span><span class='line'>input.txt  ks-script-iuQ695  ks-script-iuQ695.log  output.txt  stderr  try.txt  vboxguest-Module.symvers  yum.log
</span><span class='line'><span class="o">[</span>vagrant@bogon tmp<span class="o">]</span><span class="nv">$ </span>touch something.txt
</span><span class='line'><span class="o">[</span>vagrant@bogon tmp<span class="o">]</span><span class="nv">$ </span><span class="nb">exit</span>
</span><span class='line'><span class="nb">exit</span>
</span><span class='line'>Script <span class="k">done</span>, file is output.session
</span></code></pre></td></tr></table></div></figure>


<p>So the <code>-t</code> would record the time and <code>-a</code> would record actions to different files. In the command below, we also redirect the error message to <code>timing.log</code> file.
And if we want to replay it, just use the <code>scriptreplay</code> command, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>scriptreplay timing.log output.session
</span></code></pre></td></tr></table></div></figure>


<p>Then it would play what you have done before.
The thing you need to pay attention to is that such recording just happen in a session, so actions like switching user to do something would break that, to my understanding. Personally, I would use <code>su user -c 'commands'</code> to solve this issue.</p>

<p>It might not be a feature used often times, but it probably would help if you want to share or show actions you&rsquo;ve done to others.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/linux/2013/10/31/math-in-shell">Math in Shell</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-31T00:00:00+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/linux/2013/10/31/math-in-shell#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/linux/2013/10/31/math-in-shell">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近半年的所作的项目中，接触了些Ops的工作，自动化工具如Chef/Puppet都用过些。这些工具都很不错，但是过程当中会遇到一些问题，需要你基础的系统/shell知识，从而认识到了其重要性，开始系统学习，目前阅读的书为: <linux shell scripting cookbook version> 以及浏览china-unix论坛。</p>

<p>Shell的强大是毋庸置疑的，所以进行数学运算也就是理所应当具有的功能。Shell可以用<code>declare/let/(( ))/[]</code>进行一些简单的数学运算。
Shell 支持的运算:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ARITHMETIC EVALUATION
</span><span class='line'>       The  shell  allows arithmetic expressions to be evaluated, under certain circumstances <span class="o">(</span>see the <span class="nb">let </span>and <span class="nb">declare builtin </span>commands and Arithmetic Expansion<span class="o">)</span>.
</span><span class='line'>       Evaluation is <span class="k">done</span> in fixed-width integers with no check <span class="k">for</span> overflow, though division by <span class="m">0</span> is trapped and flagged as an error.  The  operators  and  their
</span><span class='line'>       precedence, associativity, and values are the same as in the C language.  The following list of operators is grouped into levels of equal-precedence opera-
</span><span class='line'>       tors.  The levels are listed in order of decreasing precedence.
</span><span class='line'>
</span><span class='line'>       id++ id--
</span><span class='line'>              variable post-increment and post-decrement
</span><span class='line'>       ++id --id
</span><span class='line'>              variable pre-increment and pre-decrement
</span><span class='line'>       - +    unary minus and plus
</span><span class='line'>       ! ~    logical and bitwise negation
</span><span class='line'>       **     exponentiation
</span><span class='line'>       * / %  multiplication, division, remainder
</span><span class='line'>       + -    addition, subtraction
</span><span class='line'>       &lt;&lt; &gt;&gt;  left and right bitwise shifts
</span><span class='line'>       &lt;<span class="o">=</span> &gt;<span class="o">=</span> &lt; &gt;
</span><span class='line'>              <span class="nv">comparison</span>
</span><span class='line'>       <span class="o">==</span> !<span class="o">=</span>  equality and inequality
</span><span class='line'>       <span class="p">&amp;</span>      bitwise AND
</span><span class='line'>       ^      bitwise exclusive OR
</span><span class='line'>       <span class="p">|</span>      bitwise OR
</span><span class='line'>       <span class="o">&amp;&amp;</span>     logical AND
</span><span class='line'>       <span class="o">||</span>     logical OR
</span><span class='line'>       expr?expr:expr
</span><span class='line'>              conditional <span class="nv">operator</span>
</span><span class='line'>       <span class="o">=</span> *<span class="o">=</span> /<span class="o">=</span> %<span class="o">=</span> +<span class="o">=</span> -<span class="o">=</span> &lt;&lt;<span class="o">=</span> &gt;&gt;<span class="o">=</span> <span class="p">&amp;</span><span class="o">=</span> ^<span class="o">=</span> <span class="p">|</span><span class="o">=</span>
</span><span class='line'>              assignment
</span><span class='line'>       expr1 , expr2
</span><span class='line'>              comma
</span></code></pre></td></tr></table></div></figure>


<p>可以看到涵盖了通用的编程语言中的数学运算方式，那么在shell中可以通过那些命令来进行计算呢？</p>

<p><code>declare</code>: 声明变量同时定义其属性。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nv">n</span><span class="o">=</span>1*2*9/3
</span><span class='line'><span class="nb">echo</span> <span class="nv">$n</span>
</span><span class='line'><span class="nb">declare</span> -i n
</span><span class='line'><span class="nv">n</span><span class="o">=</span>1*2*9/3
</span><span class='line'><span class="nb">echo</span> <span class="nv">$n</span>
</span><span class='line'>
</span><span class='line'>result:
</span><span class='line'>1*2*9/3
</span><span class='line'>
</span><span class='line'>6
</span></code></pre></td></tr></table></div></figure>


<p>从上面的例子可以看出，只有将变量声明为整数，shell才会认为你是在尝试进行数学运算而不是单纯的字符串变量。</p>

<p><code>expr</code>: 数学表达式运算</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">z</span><span class="o">=</span><span class="sb">`</span>expr <span class="m">5</span> + 1<span class="sb">`</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$z</span>
</span><span class='line'><span class="nv">a</span><span class="o">=</span><span class="sb">`</span>expr <span class="m">7</span> % 2<span class="sb">`</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$a</span>
</span><span class='line'><span class="nv">d</span><span class="o">=</span><span class="sb">`</span>expr <span class="m">1</span> <span class="se">\&amp;</span> 0<span class="sb">`</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$d</span>
</span><span class='line'><span class="c">#error</span>
</span><span class='line'><span class="nv">b</span><span class="o">=</span><span class="sb">`</span>expr 7*2<span class="sb">`</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$b</span>
</span><span class='line'>
</span><span class='line'>result:
</span><span class='line'>6
</span><span class='line'>1
</span><span class='line'>0
</span><span class='line'>7*2
</span></code></pre></td></tr></table></div></figure>


<p>expr后所带的表达式运算符必须以空格分开，不然会被当做字符串，不会进行运算，一些meta字符比如&amp; %等，必须转义才可以执行。</p>

<p><code>let</code>:  后面跟随数学表达式并进行运算</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ a</span><span class="o">=</span>2
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ b</span><span class="o">=</span>2
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">let </span><span class="nv">result</span><span class="o">=</span>a+b
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$result</span>
</span><span class='line'>4
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">let </span>result++
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$result</span>
</span><span class='line'>5
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">let </span>result--
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$result</span>
</span><span class='line'>4
</span></code></pre></td></tr></table></div></figure>


<p>同样，在计算的时候需要用空格分隔。</p>

<p><code>(( ))</code> 和<code>[]</code>也可以起到类似的作用。参加如下的例子:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ a</span><span class="o">=</span>1
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ b</span><span class="o">=</span>2
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ result</span><span class="o">=</span><span class="nv">$[</span> a + b <span class="o">]</span>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$result</span>
</span><span class='line'>3
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ result</span><span class="o">=</span><span class="nv">$[</span> <span class="nv">$a</span> + b <span class="o">]</span>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$result</span>
</span><span class='line'>3
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ result</span><span class="o">=</span><span class="k">$((</span><span class="nv">$a</span> <span class="o">+</span> <span class="m">50</span><span class="k">))</span>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$result</span>
</span><span class='line'>51
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ result</span><span class="o">=</span><span class="k">$((</span><span class="nv">$a</span> <span class="o">-</span> <span class="m">50</span><span class="k">))</span>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$result</span>
</span><span class='line'>-49
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="k">$((</span><span class="m">16#2</span>a<span class="k">))</span>  <span class="c">#进制转换,将16进制的”2a”转换为十进制的数字, 相当酷帅吊炸天</span>
</span><span class='line'><span class="m">42</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="k">$((</span><span class="m">2#1111</span><span class="k">))</span>
</span><span class='line'>15
</span></code></pre></td></tr></table></div></figure>


<p><code>(())</code>或者<code>[]</code>中的变量也可以加或者不加$符号从表达式外获取。以上这些命令只能处理整数运算，如果想要进行浮点数运算，就得求助<code>bc</code>命令了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost shell<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;5 * 0.86&quot;</span> <span class="p">|</span> bc
</span><span class='line'>4.30
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ n</span><span class="o">=</span>40
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span> <span class="nb">echo</span> <span class="s2">&quot;$n * 0.86&quot;</span> <span class="p">|</span> bc
</span><span class='line'>34.40
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;scale=3;4/7&quot;</span> <span class="p">|</span> bc   <span class="c">#指定十进制浮点运算的精度</span>
</span><span class='line'>.571
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">umask</span>
</span><span class='line'>0002
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;obase=8;$(( 8#666 &amp; (8#777 ^ 8#$(umask)) ))&quot;</span> <span class="p">|</span> bc
</span><span class='line'>664
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ no</span><span class="o">=</span>100
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;obase=2;$no&quot;</span> <span class="p">|</span> bc   <span class="c">#进制转换, 10进制-&gt; 2进制</span>
</span><span class='line'>1100100
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;sqrt(100)&quot;</span> <span class="p">|</span> bc <span class="c">#开方</span>
</span><span class='line'>10
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;10^10&quot;</span> <span class="p">|</span> bc   <span class="c">#次方计算</span>
</span><span class='line'>10000000000
</span></code></pre></td></tr></table></div></figure>


<p><code>bc</code>的功能远超上面所列举的例子，想仔细研究的话就 <code>man bc</code>…., enjoy。</p>

<p>references:<a href="http://www.sal.ksu.edu/faculty/tim/unix_sg/bash/math.html">1</a>, <a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&amp;tid=218853&amp;page=7#pid1617953">2</a>, <a href="http://www.amazon.com/Linux-Scripting-Cookbook-Second-Edition/dp/1782162747">3</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/linux/2013/10/29/learning-centos-yum4-advanced-commands--etc">Learning Centos: Yum(4) Advanced Commands & Etc</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-29T00:00:00+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/linux/2013/10/29/learning-centos-yum4-advanced-commands--etc#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/linux/2013/10/29/learning-centos-yum4-advanced-commands--etc">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://iambowen.github.io/2013/07/31/learning-yum3-basic-commands/">前一篇</a> YUM基本命令，介绍了工作中比较常用的一些命令。除此之外，YUM还有些不太常用的但是还算比较有趣的命令，在此我们稍微探索发现下。</p>

<p><code>yum shell</code>: yum内建的交互式shell</p>

<p>在这个shell中，我们可以进行各种操作，比如罗列所有repo，搜索/查看软件信息等等。eg:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>sudo yum shell
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Setting up Yum Shell
</span><span class='line'>&gt; search vim-common
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'> * base: mirrors.btte.net
</span><span class='line'> * extras: mirrors.stuhome.net
</span><span class='line'> * updates: mirrors.btte.net
</span><span class='line'>N/S Matched: vim-common <span class="o">==============================================================================</span>
</span><span class='line'>vim-common.x86_64 : The common files needed by any version of the VIM editor
</span></code></pre></td></tr></table></div></figure>


<p>好处非常明显，就是免掉了每次去多输入”yum”。实际的测试发现，除了<code>Install/Remove</code>之外，大多数的命令都可以在这个shell下执行。其中的原因不太明白，也没有找到合理的解释。</p>

<p><code>yum history</code>: 记录所有yum transaction的历史
yum 的transaction 记录都被保存在/var/lib/yum/history/ 下的sqlite db文件中，通过history命令，我们可以查看到软件安装的详细记录，执行者，具体操作，影响的package等。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> <span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>sudo yum <span class="nb">history</span>
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>ID     <span class="p">|</span> Login user               <span class="p">|</span> Date and <span class="nb">time</span>    <span class="p">|</span> Action<span class="o">(</span>s<span class="o">)</span>      <span class="p">|</span> Altered
</span><span class='line'>-------------------------------------------------------------------------------
</span><span class='line'> <span class="m">7</span> <span class="p">|</span>  &lt;vagrant&gt;               <span class="p">|</span> 2013-10-26 06:30 <span class="p">|</span> Install        <span class="p">|</span>   58
</span><span class='line'> <span class="m">6</span> <span class="p">|</span>  &lt;vagrant&gt;               <span class="p">|</span> 2013-10-26 05:08 <span class="p">|</span> Install        <span class="p">|</span>    3
</span><span class='line'> <span class="m">5</span> <span class="p">|</span>  &lt;vagrant&gt;               <span class="p">|</span> 2013-09-25 08:25 <span class="p">|</span> Install        <span class="p">|</span>    3
</span><span class='line'> <span class="m">4</span> <span class="p">|</span>  &lt;vagrant&gt;               <span class="p">|</span> 2013-09-24 07:04 <span class="p">|</span> Install        <span class="p">|</span>    1
</span><span class='line'> <span class="m">3</span> <span class="p">|</span>  &lt;veewee&gt;                <span class="p">|</span> 2013-03-09 15:50 <span class="p">|</span> Install        <span class="p">|</span>   <span class="m">16</span>  &lt;
</span><span class='line'> <span class="m">2</span> <span class="p">|</span>  &lt;veewee&gt;                <span class="p">|</span> 2013-03-09 15:49 <span class="p">|</span> I, U           <span class="p">|</span>   <span class="m">40</span> &gt;
</span><span class='line'> <span class="m">1</span> <span class="p">|</span> System &lt;<span class="nb">unset</span>&gt;           <span class="p">|</span> 2013-03-09 15:37 <span class="p">|</span> Install        <span class="p">|</span>  199
</span></code></pre></td></tr></table></div></figure>


<p>通过ID可以查找Transaction发生时候的相关信息。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>sudo yum <span class="nb">history </span>info 3
</span><span class='line'>Loaded plugins: fastestmirror
</span><span class='line'>Transaction ID : 3
</span><span class='line'>Begin <span class="nb">time</span>     : Sat Mar  <span class="m">9</span> 15:50:00 2013
</span><span class='line'>Begin rpmdb    : 239:6f5a8ecd22e6f0a663940801ef56d66b2ad40228
</span><span class='line'>End <span class="nb">time</span>       :            15:50:07 <span class="m">2013</span> <span class="o">(</span><span class="m">7</span> seconds<span class="o">)</span>
</span><span class='line'>End rpmdb      : 255:92e8267085fc364911baebaf646b14856fb20498
</span><span class='line'>User           :  &lt;veewee&gt;
</span><span class='line'>Return-Code    : Success
</span><span class='line'>Command Line   : -y install puppet facter
</span><span class='line'>Transaction performed with:
</span><span class='line'>    Installed     rpm-4.8.0-32.el6.x86_64                       @anaconda-CentOS-201303020151.x86_64/6.4
</span><span class='line'>    Installed     yum-3.2.29-40.el6.centos.noarch               @anaconda-CentOS-201303020151.x86_64/6.4
</span><span class='line'>    Installed     yum-plugin-fastestmirror-1.1.30-14.el6.noarch @anaconda-CentOS-201303020151.x86_64/6.4
</span><span class='line'>Packages Altered:
</span><span class='line'>    Dep-Install augeas-libs-0.9.0-4.el6.x86_64        @base
</span><span class='line'>    Dep-Install compat-readline5-5.2-17.1.el6.x86_64  @base
</span><span class='line'>    Dep-Install dmidecode-1:2.11-2.el6.x86_64         @base
</span><span class='line'>    Install     facter-1:1.6.17-1.el6.x86_64          @puppetlabs
</span><span class='line'>    Dep-Install hiera-1.1.2-1.el6.noarch              @puppetlabs
</span><span class='line'>    ...
</span></code></pre></td></tr></table></div></figure>


<p>既然可以记录Transaction，那么势必也会提供undo和redo的功能:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>   sudo yum <span class="nb">history </span>undo <span class="m">7</span>  <span class="c">#将Transaction 7中安装的所有软件都删除</span>
</span><span class='line'>   sudo yum <span class="nb">history </span>redo <span class="m">8</span>  <span class="c">#将Transaction 7中删除的软件重新安装</span>
</span></code></pre></td></tr></table></div></figure>


<p>对于系统管理员来说，这应该算得上是个比较有用的命令。前面提到yum的交易记录数据库文件保存在 <code>/var/lib/yum/history/</code>下面，如果想将Transction记录到新的db文件中，可以用<code>yum history new</code>，它会清空<code>/var/lib/yum/history/</code>目录，然后新建db文件。想打开某个history记录文件可以用<code>yum load-transaction file_name</code>。</p>

<p><code>yum provides</code> :  通过软件安装后的可执行文件，反查安装它的package</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>yum provides /usr/bin/vim
</span><span class='line'>1:vim-enhanced-7.2.411-1.8.el6.x86_64 : A version of the VIM editor which includes recent enhancements
</span><span class='line'>Repo        : installed
</span><span class='line'>Matched from:
</span><span class='line'>Other       : Provides-match: /usr/bin/vim
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>yum provides wget
</span><span class='line'>wget-1.12-1.8.el6.x86_64 : A utility <span class="k">for</span> retrieving files using the HTTP or FTP protocols
</span><span class='line'>Repo        : installed
</span><span class='line'>Matched from:
</span><span class='line'>Other       : Provides-match: wget
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>yum provides /*/vi
</span><span class='line'>1:vim-minimal-7.2.411-1.8.el6.x86_64 : A minimal version of the VIM editor
</span><span class='line'>Repo        : installed
</span><span class='line'>Matched from:
</span><span class='line'>Other       : Provides-match: /bin/vi
</span></code></pre></td></tr></table></div></figure>


<p>这个命令还是略有用处的。</p>

<p><code>yum downgrade</code>: 版本回滚</p>

<p>在持续部署出错时候，使用downgrade可以顺利进行版本的回滚。</p>

<p>好吧，熟悉了这些个命令和相关配置，我相信，从使用的角度讲，已经相当的足够了。下一篇将尝试搭建自己的yum repo服务器。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/database/2013/10/26/be-careful-when-you-playing-with-history-database">Be Careful When You Playing With History Database</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-26T00:00:00+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/database/2013/10/26/be-careful-when-you-playing-with-history-database#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/database/2013/10/26/be-careful-when-you-playing-with-history-database">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When we talking about History database, we are generally saying the database that deposit the actions performed on other databases by application. It is freaking important for recording the critical action that performed by users in both  business and development point of view.  With the help of ChangeLog database, we can easily track that an purchased transaction has or has not happened at certain time, thus by querying this table, we will 100% sure if the user wants to confirm with the transaction.</p>

<p>A typical table, say ChangeLog in History database, would have such kind of schema:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mysql&gt; show create table ChangeLog<span class="se">\G</span>
</span><span class='line'>*************************** 1. row ***************************
</span><span class='line'>       Table: ChangeLog
</span><span class='line'>Create Table: CREATE TABLE <span class="sb">`</span>ChangeLog<span class="sb">`</span> <span class="o">(</span>
</span><span class='line'>  <span class="sb">`</span>ID<span class="sb">`</span> bigint<span class="o">(</span>40<span class="o">)</span> NOT NULL AUTO_INCREMENT,
</span><span class='line'>  <span class="sb">`</span>TableName<span class="sb">`</span> varchar<span class="o">(</span>40<span class="o">)</span> DEFAULT NULL,
</span><span class='line'>  <span class="sb">`</span>ForeignKey<span class="sb">`</span> varchar<span class="o">(</span>40<span class="o">)</span> DEFAULT NULL,
</span><span class='line'>  <span class="sb">`</span>Who<span class="sb">`</span> varchar<span class="o">(</span>255<span class="o">)</span> DEFAULT NULL,
</span><span class='line'>  <span class="sb">`</span>Field<span class="sb">`</span> varchar<span class="o">(</span>40<span class="o">)</span> DEFAULT NULL,
</span><span class='line'>  <span class="sb">`</span>Mod<span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> NOT NULL DEFAULT <span class="s1">&#39;0&#39;</span>,
</span><span class='line'>  <span class="sb">`</span>OldValue<span class="sb">`</span> text,
</span><span class='line'>  <span class="sb">`</span>NewValue<span class="sb">`</span> text,
</span><span class='line'>  <span class="sb">`</span>Comments<span class="sb">`</span> varchar<span class="o">(</span>200<span class="o">)</span> DEFAULT NULL,
</span><span class='line'>  PRIMARY KEY <span class="o">(</span><span class="sb">`</span>ID<span class="sb">`</span>,<span class="sb">`</span>Mod<span class="sb">`</span><span class="o">)</span>,
</span><span class='line'>  KEY <span class="sb">`</span>idx1<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>TableName<span class="sb">`</span>,<span class="sb">`</span>ForeignKey<span class="sb">`</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="nv">ENGINE</span><span class="o">=</span>InnoDB DEFAULT <span class="nv">CHARSET</span><span class="o">=</span>latin1
</span></code></pre></td></tr></table></div></figure>


<p>The schema shows that it would record action done on some table by someone from certain value to other value on certain time. Two columns, TableName and ForeignKey, are indexed, which would be faster if you take those two in the where clause. The thing you need to aware is that index of ForeignKey is only working when TableName is also existed in the where clause.</p>

<p>History database is normally huge and rarely has replica, as we can imagine. The reason, I suspect, is the changing-write/read operation much more frequently than other tables. Normally, it has several following characters:</p>

<ol>
<li>Query/Scan/Join operation could cause performance on database for it has large bunch of data;</li>
<li>It&rsquo;s pretty pretty important that I don’t need to talk about this twice;</li>
<li>Things in the history database is genuine, application or log can fake but the history table does not lie;</li>
<li>Since it’s might be the only database, clearly it’s not</li>
</ol>


<p>Due to the importance of History database, few people would have access. But there gonna be chance that you would talk to it. And the following are the tips I learned from a senior developer about interacting with History database:</p>

<ol>
<li>Pair with someone who are experienced and can make sure the query you write would not do harm to the database;</li>
<li>Check the ChangeLog table schema first, attention whether it has some columns indexed;</li>
<li>Use “&ndash;“  in the beginning to comment out your query in case if you hit enter before you complete the query;</li>
<li>To “explain" the query you want to run firstly, to see whether the query would happen in a very large dataset, if it is, then you need to consider the consequent for running the query.</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mysql&gt; Explain <span class="k">select</span> * from ChangeLog where <span class="nv">TableName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> and <span class="nv">ForeignKey</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>+----+-------------+-----------+------+---------------+------+---------+-------------+------+-------------+
</span><span class='line'><span class="p">|</span> id <span class="p">|</span> select_type <span class="p">|</span> table     <span class="p">|</span> <span class="nb">type</span> <span class="p">|</span> possible_keys <span class="p">|</span> key  <span class="p">|</span> key_len <span class="p">|</span> ref         <span class="p">|</span> rows <span class="p">|</span> Extra       <span class="p">|</span>
</span><span class='line'>+----+-------------+-----------+------+---------------+------+---------+-------------+------+-------------+
</span><span class='line'><span class="p">|</span>  <span class="m">1</span> <span class="p">|</span> SIMPLE      <span class="p">|</span> ChangeLog <span class="p">|</span> ref  <span class="p">|</span> idx1          <span class="p">|</span> idx1 <span class="p">|</span> <span class="m">86</span>      <span class="p">|</span> const,const <span class="p">|</span>   <span class="m">61</span> <span class="p">|</span> Using where <span class="p">|</span>
</span><span class='line'>+----+-------------+-----------+------+---------------+------+---------+-------------+------+-------------+
</span><span class='line'><span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.47 sec<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What we can see from the result of explain is that the query would happen only in 61 rows, which would barely cause performance issue on the database. Of course, good to go.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/linux/2013/10/21/set-locale-in-debian-wheezy">Set Locale in Debian Wheezy</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-21T00:00:00+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/linux/2013/10/21/set-locale-in-debian-wheezy#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/linux/2013/10/21/set-locale-in-debian-wheezy">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近和一个客户聊天，说到一个很有意思的事情。他认为，在产品环境使用*inx的情况下，公司给开发人员普遍
配发Mac是不太合适的, 当然这个是见仁见智了。不过,如果对产品环境的系统熟悉的话，在遇到一些问题的时候，可以节省些时间。</p>

<p>想把Mac Book/Air操作系统更换成Linux代价还是略高，所以最好的办法是用虚拟机,必须就是Vagrant了。今天在使用Debian7 Wheezy的时候，就遇到了关于Locale的简单问题。</p>

<p><a href="http://gerardnico.com/wiki/application/locale">locale</a>是关于系统语言和区域选择，目的是为了表示正确的时间和数字格式。悲剧的是，下载的debian 7的virtual box默认竟然是用法语，提示信息各种看不懂。只好自己查找资料修改了。</p>

<p>最初使用的方法是修改LANG/LC_ALL的环境变量:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  <span class="nb">echo</span> -e <span class="s2">&quot;export LANG=en_us.UTF-8 \nexport LC_ALL=en_us.UTF-8&quot;</span> &gt;&gt; ~/.bash_profile<span class="p">;</span>
</span><span class='line'>  <span class="nb">source</span> ~/.bash_profile
</span></code></pre></td></tr></table></div></figure>


<p>奇怪的是，并非是所有的输出消息都变成了英文，仍然有法语出现。于是，尝试从根上修改:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  sudo vi /etc/default/locale
</span><span class='line'>  <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
</span></code></pre></td></tr></table></div></figure>


<p>重启系统，按照常理应该已经OK，怎知还是出现警告，说设置locale失败。技穷只能求助文档，先查看了下当前
locale中已有的语言环境:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  vagrant@vagrant-debian-wheezy:~<span class="nv">$ </span>locale -a
</span><span class='line'>  C
</span><span class='line'>  C.UTF-8
</span><span class='line'>  POSIX
</span><span class='line'>  fr_FR.utf8
</span></code></pre></td></tr></table></div></figure>


<p>我去，只有这么几个选项，只能重头添加en_US.UTF-8了。所幸并不是很困难:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  sudo /usr/sbin/dpkg-reconfigure  locales
</span></code></pre></td></tr></table></div></figure>


<p>在弹出的选项框中，选中en_US.UTF-8确定即可。这个时候/etc/default/locale文件也被修改成支持en_US.UTF-8，运行下 locale -a :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-debian-wheezy:~<span class="nv">$ </span>locale -a
</span><span class='line'>C
</span><span class='line'>C.UTF-8
</span><span class='line'>POSIX
</span><span class='line'>en_US.utf8
</span><span class='line'>fr_FR.utf8
</span></code></pre></td></tr></table></div></figure>


<p>Nice.
<a href="http://people.debian.org/~schultmc/locales.html">reference</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/linux/2013/07/31/learning-yum3-basic-commands">Learning Yum(3): Basic Commands</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-07-31T00:00:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/linux/2013/07/31/learning-yum3-basic-commands#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/linux/2013/07/31/learning-yum3-basic-commands">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>对于包管理工具来说，安装/删除/查看包信息/升级软件包/搜索查找/清除metadata, 都是必须提供的功能。yum的基本命令操作同样也可以概括为:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>install/(remove|erase|downgrade)/(list|info)/(update|upgrade)/search/clean</span></code></pre></td></tr></table></div></figure>


<p><strong>安装package:</strong><br/>
yum安装package有两种方式，一种是安装单个/多个的package，一种是安装软件组。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install package_names
</span><span class='line'>yum install  -y<span class="o">(</span>--ausumeyes<span class="o">)</span> package_names
</span><span class='line'>yum install --enablerepo<span class="o">=</span>drivers nvidia-driver
</span></code></pre></td></tr></table></div></figure>


<p>install的时候可以指定或者不指定具体的版本号，正常安装的时候会提示是否确认安装。为了偷懒或者在自动化部署的时候，想在跳过提示，可以加上个<code>-y</code>的参数，就可以了。有些repo可能默认被disable了，只想在单次的yum install的时候enable，可以加上 <code>--enablerepo=&lt;repo name&gt;</code>.</p>

<p><strong>组安装:</strong><br/>
想知道当前repo都提供了哪些package group，可以用<code>yum -v grouplist</code>，可以知道组名及组id。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>yum -v grouplist kde<span class="se">\*</span>
</span><span class='line'>Config <span class="nb">time</span>: 0.009
</span><span class='line'>Yum Version: 3.2.29
</span><span class='line'>Setting up Group Process
</span><span class='line'>rpmdb <span class="nb">time</span>: 0.001
</span><span class='line'>group <span class="nb">time</span>: 0.159
</span><span class='line'>Available Groups:
</span><span class='line'>   KDE Desktop <span class="o">(</span>kde-desktop<span class="o">)</span>   <span class="c"># KDE Desktop 组的id 就是(kde-desktop)</span>
</span><span class='line'>Done
</span></code></pre></td></tr></table></div></figure>


<p>组安装的有几种不同形式，但是结果都是相同的，如下的几个命令都会安装KDE Desktop的groupyum groupinstall &ldquo;KDE Desktop&rdquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum groupinstall kde-desktop
</span><span class='line'>yum install @kde-desktop
</span></code></pre></td></tr></table></div></figure>


<p><strong>删除package:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum remove package_name
</span><span class='line'>yum remove glibc*
</span><span class='line'>yum erase package_name/glob expression
</span><span class='line'>yum groupremove  <span class="c">#删除软件组</span>
</span></code></pre></td></tr></table></div></figure>


<p>开始我以为remove和erase是有区别的，但是后来在fedora社区论坛上发现其实它们没什么区别，很汗啊，上次分享的时候我还信誓旦旦的说了来着，都是被apt搞混了。</p>

<p><strong>查看package信息:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum info package_name   等同于rpm -q --info package_name
</span><span class='line'>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>yum info vim-common
</span><span class='line'>Installed Packages
</span><span class='line'>Name        : vim-common
</span><span class='line'>Arch        : x86_64
</span><span class='line'>Epoch       : 2
</span><span class='line'>Version     : 7.2.411
</span><span class='line'>Release     : 1.8.el6
</span><span class='line'>Size        : <span class="m">17</span> M
</span><span class='line'>Repo        : installed
</span><span class='line'>From repo   : base
</span><span class='line'>Summary     : The common files needed by any version of the VIM editor
</span><span class='line'>URL         : http://www.vim.org/
</span><span class='line'>License     : Vim and GPLv2+ and BSD and LGPLv2+ and Open Publication
</span><span class='line'>Description : VIM <span class="o">(</span>VIsual editor iMproved<span class="o">)</span> is an updated and improved version of the
</span><span class='line'>            : vi editor.  Vi was the first real screen-based editor <span class="k">for</span> UNIX, and is........
</span></code></pre></td></tr></table></div></figure>


<p>可以看到package相关的所有信息，</p>

<p><strong>罗列packages信息:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum list <span class="o">[</span>available<span class="p">|</span>installed<span class="p">|</span>extras<span class="p">|</span>updates<span class="p">|</span>obsoletes<span class="p">|</span>all<span class="p">|</span>recent<span class="o">]</span> <span class="o">[</span>pkgspec<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum list available 列出当前enable的repo中所有可用package
</span><span class='line'>yum list installed 列出当前系统中已经安装的package
</span><span class='line'>yum list extras 列出已安装的package中不在enable的repo中的package
</span><span class='line'>yum list updates  列出当前enable的repo中可以提供更新的package
</span><span class='line'>yum list obsoletes 列出enable的repo中或者已安装的package中被淘汰的package
</span><span class='line'>yum list all 列出所有enable的repo中的package
</span><span class='line'>yum list recent 列出所有enable的repo中最近一周添加的package
</span><span class='line'>yum list installed <span class="s2">&quot;krb?-*&quot;</span> 以上所有的list命令都支持通配符，罗列相关的package信息
</span><span class='line'>yum list package spec  为特定的package列出相关信息，比如列出glibc的信息
</span><span class='line'><span class="o">[</span>vagrant@localhost yum.repos.d<span class="o">]</span><span class="nv">$ </span>yum list glibc
</span><span class='line'>Installed Packages
</span><span class='line'>glibc.x86_64                                                       2.12-1.107.el6                                                            @anaconda-CentOS-201303020151.x86_64/6.4
</span><span class='line'>Available Packages
</span><span class='line'>glibc.i686                                                         2.12-1.107.el6_4.2                                                        updates
</span><span class='line'>glibc.x86_64                                                       2.12-1.107.el6_4.2                                                        updates
</span><span class='line'>
</span><span class='line'>yum list  <span class="se">\*</span>.i686  <span class="c">#glob expression</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>罗列组信息:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum grouplist
</span><span class='line'>yum -v grouplist  <span class="s2">&quot;KDE*&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>查看repo信息:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum repolist
</span></code></pre></td></tr></table></div></figure>


<p><strong>更新package:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum check-update  <span class="c">#检查有更新的软件，返回的值分别为可以更新的package所在repo已经最新的版本号</span>
</span><span class='line'>yum check-update glibc*   <span class="c">#检查单一的package，支持通配符</span>
</span><span class='line'><span class="o">[</span>vagrant@localhost yum.repos.d<span class="o">]</span><span class="nv">$ </span>yum check-update
</span><span class='line'>glibc.x86_64                                                                            2.12-1.107.el6_4.2                                                                    updates
</span><span class='line'>
</span><span class='line'>yum update   <span class="c">#升级所有已安装package有更新的package</span>
</span><span class='line'>yum update glibc <span class="c">#升级某一个package</span>
</span><span class='line'>yum update glibc*  <span class="c">#升级某一票package</span>
</span><span class='line'>
</span><span class='line'>yum upgrade  <span class="c">#和update类似，但是会考虑淘汰的package</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>搜索软件包:</strong><br/>
<code>yum search</code> yum 提供了软件包搜索的功能，可以通过关键字(package描述|package名)搜索到你想要的软件包。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@localhost yum.repos.d<span class="o">]</span><span class="nv">$ </span>yum search <span class="nv">vim</span>
</span><span class='line'><span class="o">===================================================================================</span> Matched: <span class="nv">vim</span> <span class="o">====================================================================================</span>
</span><span class='line'>vim-X11.x86_64 : The VIM version of the vi editor <span class="k">for</span> the X Window System
</span><span class='line'>vim-common.x86_64 : The common files needed by any version of the VIM editor
</span><span class='line'>vim-enhanced.x86_64 : A version of the VIM editor which includes recent enhancements
</span><span class='line'>vim-minimal.x86_64 : A minimal version of the VIM editor
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@localhost yum.repos.d<span class="o">]</span><span class="nv">$ </span>yum search <span class="s2">&quot;vi editor&quot;</span> <span class="c">#只需要描述软件提供的功能，便可以查找出提供该功能的软件包</span>
</span><span class='line'><span class="o">==============================================================================</span> N/S Matched: vi <span class="nv">editor</span> <span class="o">===============================================================================</span>
</span><span class='line'>vim-X11.x86_64 : The VIM version of the vi editor <span class="k">for</span> the X Window System
</span></code></pre></td></tr></table></div></figure>


<p><strong>清理本地cached metadata 和package:</strong><br/>
减少占用的磁盘空间，或者处理metadata出错的情况:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum clean  <span class="c">#默认清理cached package和metadata，cache的目录是/var/cache/yum/</span>
</span><span class='line'>yum clean packages <span class="c">#只清理cached package</span>
</span><span class='line'>yum clean metadata <span class="c">#只清理metadata</span>
</span><span class='line'>yum clean dbcache   <span class="c">#清理yum的sqllite数据库文件</span>
</span><span class='line'>yum clean all     <span class="c">#清理</span>
</span></code></pre></td></tr></table></div></figure>


<p>常用的yum 命令大概就有这么些，我们可以发现:<br/>
1. yum基本的命令使用模式比较接近, 而且都是正常人的使用逻辑;<br/>
2. yum的命令一般都会支持通配符的操作，用法比较统一；<br/>
下一次我们将介绍一些平常不太用yum但是还有点意思的命令。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/linux/2013/07/25/learning-yum2-utils-and-plugins">Learning Yum(2): Utils and Plugins</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-07-25T00:00:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/linux/2013/07/25/learning-yum2-utils-and-plugins#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/linux/2013/07/25/learning-yum2-utils-and-plugins">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Yum 提供了一些列的utils以及plugins来增强自身的功能，比如yum-config-manager，fastestmirror等。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>yum info yum-utils
</span><span class='line'>.......
</span><span class='line'>Description:
</span><span class='line'>yum-utils is a collection of utilities and examples <span class="k">for</span> the yum package manager. It includes utilities by different authors that make yum easier and more powerful to use. These tools include:
</span><span class='line'>: debuginfo-install, find-repos-of-install, repodiff,
</span><span class='line'>: needs-restarting, package-cleanup, repoclosure,
</span><span class='line'>: repo-graph, repomanage, repoquery, repo-rss, reposync,
</span><span class='line'>: repotrack, show-installed, show-changed-rco, verifytree,
</span><span class='line'>: yum-builddep, yum-complete-transaction, yumdownloader,
</span><span class='line'>: yum-config-manager, yum-debug-dump,
</span><span class='line'>: yum-debug-restore and yum-groups-manager.
</span></code></pre></td></tr></table></div></figure>


<p>它们各自的作用可以很容易从自己的命名上看的出来, 我们挑几看上去有意思的命令研究下， 比如yum-config-manager，yumdownloader，find-repos-of-install等。</p>

<p>yum-config-manager: yum配置管理工具
显示base这个repo显示的所有的配置项以及其对应的值:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum-config-manager base
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>yum-config-manager <span class="nv">base</span>
</span><span class='line'><span class="o">========</span> repo: base
</span><span class='line'><span class="o">[</span>base<span class="o">]</span>
</span><span class='line'><span class="nv">base_persistdir</span> <span class="o">=</span> /var/lib/yum/repos/x86_64/6
</span><span class='line'><span class="nv">baseurl</span> <span class="o">=</span> http://mirrors.163.com/centos/6/os/x86_64/
</span><span class='line'><span class="nv">cache</span> <span class="o">=</span> 0
</span><span class='line'><span class="nv">cachedir</span> <span class="o">=</span> /var/tmp/yum-vagrant-isJUZ8/x86_64/6/base
</span><span class='line'><span class="nv">enabled</span> <span class="o">=</span> True
</span><span class='line'><span class="nv">name</span> <span class="o">=</span> CentOS-6 - Base
</span><span class='line'><span class="nv">retries</span> <span class="o">=</span> 10
</span><span class='line'><span class="nv">timeout</span> <span class="o">=</span> 30.0
</span><span class='line'>......
</span></code></pre></td></tr></table></div></figure>


<p>修改base这个repo的enabled选项为false同时保存:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>sudo yum-config-manager base --setopt<span class="o">=</span>“base.enabled<span class="o">=</span>0” --save
</span><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>yum-config-manager <span class="nv">base</span>
</span><span class='line'><span class="o">========</span> repo: base
</span><span class='line'><span class="o">[</span>base<span class="o">]</span>
</span><span class='line'><span class="nv">enabled</span> <span class="o">=</span> False
</span><span class='line'>......
</span></code></pre></td></tr></table></div></figure>


<p>yumdownloader: 从yum的repo下载rpm package</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yumdownloader  --destdir /tmp/  ConsoleKit-devel-0.4.1
</span><span class='line'>ConsoleKit-devel-0.4.1-3.el6.i686.rpm      <span class="p">|</span>  <span class="m">15</span> kB     00:00
</span><span class='line'>ConsoleKit-devel-0.4.1-3.el6.x86_64.rpm    <span class="p">|</span>  <span class="m">15</span> kB     00:00
</span></code></pre></td></tr></table></div></figure>


<p>find-repos-of-install: 找到已安装package的repo源</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>find-repos-of-install vim-common
</span><span class='line'>2:vim-common-7.2.411-1.8.el6.x86_64 from repo base
</span></code></pre></td></tr></table></div></figure>


<p>试用了一些个utils命令，觉得没有那些是特别有用的，只是能够稍微提高下效率，比如yum-config-manager,可以直接通过这个命令修改配置。</p>

<p>当你使用yum命令的时候，会提示你加载的<a href="http://yum.baseurl.org/wiki/YumUtils">plugins</a>。相比之下，yum的plugins就显得有用多了。yum有很多plugins，aliases， axelget等都是我觉得比较有用的。配置yum plugins的入口有三个地方，我们以yum-aliases这个plugin作为示例:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>sudo yum install yum-aliases <span class="c">#安装插件</span>
</span><span class='line'>/etc/yum.conf
</span><span class='line'>  <span class="nv">plugins</span><span class="o">=</span>1/0                      <span class="c">#使用/不试用所有的插件</span>
</span><span class='line'>/etc/yum/pluginconf.d/aliases.conf
</span><span class='line'>  <span class="o">[</span>main<span class="o">]</span>
</span><span class='line'>  <span class="nv">enabled</span><span class="o">=</span>1/0                      <span class="c">#使用/不试用aliases插件</span>
</span><span class='line'>  <span class="c"># conffile - config. file to use</span>
</span><span class='line'>  <span class="c"># &lt;default&gt; = /etc/yum/aliases.conf</span>
</span><span class='line'>/etc/yum/aliases.conf
</span><span class='line'>  FORCE --skip-broken --disableexcludes<span class="o">=</span>all
</span><span class='line'>  up   upgrade
</span><span class='line'>  in   install
</span><span class='line'>  rm   remove
</span><span class='line'>  .........
</span></code></pre></td></tr></table></div></figure>


<p>/etc/yum/aliases.conf中定义了yum很多命令的alias，比如 in => install, 这样我就可以用yum in package_name,少敲几个字，节省体力。alias到option的用处会更大些，比如上面的FORCE。乐意的话，我们也可以按照个人喜好自己定制这个aliases的配置文件。</p>

<p>最近用过的一个比较有用的yum plugin是axelget，作用是从repo中下载package的时候支持多线程，加快下载速度。yum依赖于libcurl，默认应该是只能支持单线程的，如果网络条件一般的话，速度会比较慢。axelget 插件的用法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> <span class="nb">echo</span> -e <span class="s2">&quot;[main]\nenabled=1\nonlyhttp=1\nenablesize=300000\ncleanOnException=1\maxconn=10&quot;</span> &gt; /etc/yum/pluginconf.d/axelget.conf
</span><span class='line'>
</span><span class='line'> curl -o   /usr/lib/yum-plugins/axelget.py  http://yum-axelget.googlecode.com/svn/trunk/axelget.py
</span><span class='line'>
</span><span class='line'> rpm -i http://pkgs.repoforge.org/axel/axel-2.4-1.el5.rf.x86_64.rpm
</span></code></pre></td></tr></table></div></figure>


<p>axelget.conf 文件中的maxconn意为同时下载的线程数量。在我们项目中，从build pipeline打包出来的rpm package是保存在企业数据中心的repo中，但是测试环境是亚马逊的美国EC2节点，处于不同的网络中。如果是自动化部署，对于一个70Mb左右的package来说，安装更新消耗的时间大概是11分钟左右，使用axelget插件后，消耗的时间不到2分钟，下载速度提升很明显。虽然还是有点慢，但是已经处于可接受范围了。如此，每次在测试环境部署新的package的时间就大大降低了。</p>

<p>如果是想在某次的yum的transaction中禁止某个plugin的话，只需要加上 &ndash;disableplugin=plugin_name的option就好了，比如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum update --disableplugin<span class="o">=</span>aliases, refresh-pack*
</span></code></pre></td></tr></table></div></figure>


<p>在开始下一篇关于yum的blog前，给大家介绍yum自动补齐的工具,懒人必备。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rpm -i http://pkgs.repoforge.org/bash-completion/bash-completion-20060301-1.el6.rf.noarch.rpm
</span><span class='line'><span class="nb">source</span> /etc/bash_completion
</span></code></pre></td></tr></table></div></figure>


<p>有了自动补齐后，就不用担心忘记命令或者费劲敲键盘了。</p>

<p>关于配置和插件等，基本就是这样了，下次介绍yum基本的命令用法。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/linux/2013/07/09/learning-yum1-config-files-explained">Learning Yum(1): Config Files Explained</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-07-09T00:00:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/linux/2013/07/09/learning-yum1-config-files-explained#disqus_thread"
             data-disqus-identifier="http://iambowen.github.com/linux/2013/07/09/learning-yum1-config-files-explained">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://en.wikipedia.org/wiki/Yellowdog_Updater,_Modified">Yum</a>是RedHat系列中(如Centos, Fedora)等软件包管理工具，全称为Yellow Dog Updater, Modified, 在RPM的基础上，它可以自动解析安装软件的依赖。最早接触Redhat的时候时的版本是Redhat9, 实在是不堪忍受各种坑爹的依赖，所以后来接触Debian/Ubuntu之后才有大喜过望的感觉。最近想多熟悉几个系统，Centos/Arch Linux都在之列(没有Fedora的原因它发布比较快，不是特别稳定)，在都使用相同内核的前提，这些发行版本的最大的不同也许就是包/软件管理器了，这就是为什么我要先开始熟悉yum了…….</p>

<p>从<a href="http://www.vagrantbox.es/">这里</a>下载Centos的virtual box镜像,添加到<a href="http://vagrantup.com/">Vagrant</a>中,你就可以拥有一个Centos的环境了，然后深度接触yum。</p>

<p>开始之前，得先知道 yum 相关的配置文件都在什么地方，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>man yum.conf
</span></code></pre></td></tr></table></div></figure>


<p>在帮助文件的底部我们就可以看到几乎所有的yum相关的配置文件:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FILES
</span><span class='line'>   /etc/yum.conf
</span><span class='line'>   /etc/yum.repos.d/
</span><span class='line'>   /etc/yum/pluginconf.d/
</span><span class='line'>   /etc/yum/protected.d
</span><span class='line'>   /etc/yum/vars
</span><span class='line'>   /etc/yum/version-groups.conf
</span></code></pre></td></tr></table></div></figure>


<p>yum 主配置文件:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/etc/yum.conf
</span></code></pre></td></tr></table></div></figure>


<p>如下为yum.conf的示例文件:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>main<span class="o">]</span>
</span><span class='line'><span class="nv">cachedir</span><span class="o">=</span>/var/cache/yum/<span class="nv">$basearch</span>/<span class="nv">$releasever</span>
</span><span class='line'><span class="nv">keepcache</span><span class="o">=</span>1
</span><span class='line'><span class="nv">debuglevel</span><span class="o">=</span>2
</span><span class='line'><span class="nv">logfile</span><span class="o">=</span>/var/log/yum.log
</span><span class='line'><span class="nv">exactarch</span><span class="o">=</span>1
</span><span class='line'><span class="nv">obsoletes</span><span class="o">=</span>1
</span><span class='line'><span class="nv">gpgcheck</span><span class="o">=</span>1
</span><span class='line'><span class="nv">plugins</span><span class="o">=</span>1
</span><span class='line'><span class="nv">installonly_limit</span><span class="o">=</span>5
</span><span class='line'><span class="nv">bugtracker_url</span><span class="o">=</span>http://bugs.centos.org/set_project.php?project_id<span class="o">=</span>16<span class="p">&amp;</span><span class="nv">ref</span><span class="o">=</span>http://bugs.centos.org/bug_report_page.php?category<span class="o">=</span>yum
</span><span class='line'><span class="nv">distroverpkg</span><span class="o">=</span>centos-release
</span></code></pre></td></tr></table></div></figure>


<p>可以看到配置文件中有大量的选项，比如选择是否在本地保存cache，cache目录在那里，log文件的位置，是否enable yum的plugin等等，详细的配置项的解释可以查看man yum.conf.
yum repos 配置文件:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>tree /etc/yum.repos.d/
</span><span class='line'>/etc/yum.repos.d/
</span><span class='line'><span class="p">|</span>-- CentOS-Base.repo
</span><span class='line'><span class="p">|</span>-- CentOS-Debuginfo.repo
</span><span class='line'><span class="p">|</span>-- CentOS-Media.repo
</span><span class='line'><span class="sb">`</span>-- CentOS-Vault.repo
</span></code></pre></td></tr></table></div></figure>


<p>配置文件中有两个section，一个是[main]，包含全局的yum配置, 一个是[repository]，包含repository的配置，定义软件仓库。 通常在主配置文件中定义main，repository定义通常放置在/etc/yum.repos.d/*.repo 文件中，扩展性非常好，如果你想添加新的软件源或者镜像，在/etc/yum.repos.d/目录下新创建一个.repo文件就好了。
yum 依赖libcurl, 所以下载的时候，是单线程的，在不使用插件的情况下，寻找一个合适的软件源是很重要的。 从<a href="http://mirror-status.centos.org/">列表</a>中找到中国的镜像，还是很多的，教育网公网服务器一半一半的样子,最奇怪的是台湾的镜像，竟然显示是台湾省，呵呵。我选择的是<a href="http://mirrors.163.com/">163的镜像</a>，步骤如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo cp CentOS-Base.repo Centos-163.repo
</span><span class='line'>sudo sed -i <span class="s1">&#39;s/^mirrorlist/\#mirrorlist/g&#39;</span> Centos-163.repo
</span><span class='line'>sudo sed -i <span class="s1">&#39;s/^\#baseurl/baseurl/g&#39;</span> Centos-163.repo
</span><span class='line'>sudo sed -i <span class="s1">&#39;s/mirror.centos.org/mirrors.163.com/g&#39;</span> Centos-163.repo
</span></code></pre></td></tr></table></div></figure>


<p>之后运行yum update metadata，就可以更新metadata/index文件了。
.repo文件中配置细节目录区别:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>base<span class="o">]</span>
</span><span class='line'><span class="nv">name</span><span class="o">=</span>CentOS-<span class="nv">$releasever</span> - Base
</span><span class='line'><span class="nv">mirrorlist</span><span class="o">=</span>http://mirrorlist.centos.org/?release<span class="o">=</span><span class="nv">$releasever</span><span class="p">&amp;</span><span class="nv">arch</span><span class="o">=</span><span class="nv">$basearch</span><span class="p">&amp;</span><span class="nv">repo</span><span class="o">=</span>os
</span><span class='line'><span class="nv">baseurl</span><span class="o">=</span>http://mirrors.163.com/centos/<span class="nv">$releasever</span>/os/<span class="nv">$basearch</span>/
</span><span class='line'>               ftp://path/to/repo
</span><span class='line'><span class="nv">gpgcheck</span><span class="o">=</span>1
</span><span class='line'><span class="nv">gpgkey</span><span class="o">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
</span><span class='line'><span class="nv">enabled</span><span class="o">=</span>1
</span></code></pre></td></tr></table></div></figure>


<p>其中base为repo的名字，baseurl支持多个url、协议，指向repo的地址。gpgcheck选项表示要不要对下载的package做校验。enabled选项表示默认情况下是否使用该repo。mirrorlist为后备的repo镜像url列表。相关的配置选项还很多，比如time_out, http_caching等，可以man yum.conf查看。</p>

<p>yum 的插件配置文件:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>tree /etc/yum/pluginconf.d/
</span><span class='line'>/etc/yum/pluginconf.d/
</span><span class='line'><span class="p">|</span>-- aliases.conf
</span><span class='line'><span class="sb">`</span>-- fastestmirror.conf
</span></code></pre></td></tr></table></div></figure>


<p>拿fastestmirror.conf作为例子看看:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>main<span class="o">]</span>
</span><span class='line'><span class="nv">enabled</span><span class="o">=</span>1
</span><span class='line'><span class="nv">verbose</span><span class="o">=</span>0
</span><span class='line'><span class="nv">always_print_best_host</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nv">socket_timeout</span><span class="o">=</span>3
</span><span class='line'><span class="nv">hostfilepath</span><span class="o">=</span>timedhosts.txt
</span><span class='line'><span class="nv">maxhostfileage</span><span class="o">=</span>10
</span><span class='line'><span class="nv">maxthreads</span><span class="o">=</span>15
</span></code></pre></td></tr></table></div></figure>


<p>其中enable选项可以打开或者关闭yum的插件。</p>

<p>/etc/yum/vars/*，自定义yum中可以引用的变量:
在yum.conf或者.repo中可以看到一些yum build-in变量，这些变量包括:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$basearch</span>
</span><span class='line'><span class="nv">$releasever</span>
</span><span class='line'><span class="nv">$arch</span>
</span><span class='line'><span class="nv">$YUM0</span>-9
</span></code></pre></td></tr></table></div></figure>


<p>$basearch读取的是yum.conf中distroverpkg的值，$arch读取的是系统的CPU的architecture, $releasever是发行版的版本号，比如Centos-6。$YUM0-9读取shell中的变量，有则取之，无则为空。如果想从系统的环境变量中fetch一些值，可以在bash中设置$YUM0-9。自定义yum变量还有一种方法是在/etc/yum/vars/下新增变量文件，比如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;It&#39;s not Ubuntu&quot;</span> &gt; /etc/yum/vars/declare
</span></code></pre></td></tr></table></div></figure>


<p>在yum.conf或者.repo文件中就可以调用$declare了，</p>

<p>/etc/yum/version-groups.conf: 定义软件组， 用yum version查看</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>yum<span class="o">]</span>
</span><span class='line'><span class="c">#  These are the top level things to do with yum, we don&#39;t list Eg. libselinux</span>
</span><span class='line'><span class="c"># even though that&#39;s require by rpm(-libs).</span>
</span><span class='line'><span class="nv">run_with_packages</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nv">pkglist</span> <span class="o">=</span> glibc, sqlite, libcurl, nss,
</span><span class='line'>          yum-metadata-parser,
</span><span class='line'>          rpm, rpm-libs, rpm-python,
</span><span class='line'>          python,
</span><span class='line'>          python-iniparse, python-urlgrabber, python-pycurl
</span></code></pre></td></tr></table></div></figure>


<p>/etc/yum/protected.d: 保护某些软件不被卸载，default只有yum，可以添加新的conf文件，比如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$echo</span> <span class="s2">&quot;vim-common&quot;</span> &gt; /etc/yum/protected.d/vim.conf
</span></code></pre></td></tr></table></div></figure>


<p>此时如果remove vim-common这个package，就会得到失败的信息:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@localhost ~<span class="o">]</span><span class="nv">$ </span>sudo yum remove vim-common
</span><span class='line'>Setting up Remove Process
</span><span class='line'>Resolving Dependencies
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package vim-common.x86_64 2:7.2.411-1.8.el6 will be erased
</span><span class='line'>--&gt; Processing Dependency: vim-common <span class="o">=</span> 2:7.2.411-1.8.el6 <span class="k">for</span> package: 2:vim-enhanced-7.2.411-1.8.el6.x86_64
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package vim-enhanced.x86_64 2:7.2.411-1.8.el6 will be erased
</span><span class='line'>--&gt; Finished Dependency Resolution
</span><span class='line'>Error: Trying to remove <span class="s2">&quot;vim-common&quot;</span>, which is protected
</span><span class='line'> You could try using --skip-broken to work around the problem
</span><span class='line'> You could try running: rpm -Va --nofiles --nodigest
</span></code></pre></td></tr></table></div></figure>


<p>关于yum config文件大概就是这些，我们下一篇介绍yum的utils以及一些有用的plugins。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/akamai/diagnostic/2016/01/19/using-akamai-diagnostic-tools-slash-api">Using Akamai Diagnostic tools/API</a>
      </li>
    
      <li class="post">
        <a href="/ci/mesos/aws/2016/01/10/ci-solution-with-mesos">Ci Solution With Mesos</a>
      </li>
    
      <li class="post">
        <a href="/aws/practice/2015/12/28/stopping-creating-new-wheels">Stop Wrapping AWS SDK to Create Tools</a>
      </li>
    
      <li class="post">
        <a href="/ssh/security/2015/12/19/ssh-securely-and-handy">更加安全和简单的方式通过堡垒机ssh</a>
      </li>
    
      <li class="post">
        <a href="/ssh/practice/2015/12/17/dont-copy-slash-paste-keys-from-chatting-tools">Don't Copy/paste Keys From Chatting Tools</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/iambowen">@iambowen</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'iambowen',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/iambowen.m@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Bowen Ma -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'iambowen';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
